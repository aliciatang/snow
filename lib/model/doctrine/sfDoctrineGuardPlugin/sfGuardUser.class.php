<?php

/**
 * sfGuardUser
 * 
 * This class has been auto-generated by the Doctrine ORM Framework
 * 
 * @package    valueInvest
 * @subpackage model
 * @author     Your name here
 * @version    SVN: $Id: Builder.php 7490 2010-03-29 19:53:27Z jwage $
 */
class sfGuardUser extends PluginsfGuardUser
{
  public function getAccountsWithTransactions()
  {
    $q = Doctrine_Query::create()
        ->from('Account a')
        ->leftJoin('a.Transactions t')
        ->orderBy('t.security_id,t.trade_date')
        ->where('a.user_id = ?', $this->getId())
        ;
    return $q->execute();
  }
  public function getAccountsWithSecurities()
  {
    $q = Doctrine_Query::create()
        ->from('Account a')
        ->leftJoin('a.Securities s')
        ->where('a.user_id = ?', $this->getId())
        ;
    return $q->execute();
  }
  public function getAccountsWithCurrentHoldings()
  {
    $q = Doctrine_Query::create()
        ->select('a.number,a.type')
        ->addSelect('sum(t.quantity) as shares')
        ->addSelect('sum(t.amount)')
        ->from('Transaction t')
        ->leftJoin('t.Account a')
        ->leftJoin('t.Security s')
        ->leftJoin('s.Price p')
        ->where('a.user_id = ?', $this->getId())
        ->orderBy('a.id,s.quantity')
        ;
    $ret = $q->fetchArray();
    foreach($ret as $i=>$a)
    {
      $ret[$i]['amount'] = 0;
      $ret[$i]['number'] = "****".substr($a['number'],-4);
      foreach($a['AccountSecurities'] as $j=>$s)
      {
        $ret[$i]['amount'] += $s['amount'];
        $ret[$i]['AccountSecurities'][$j]['avg_buy_price']=(!$s['buy_quantity'])?0:(floatval($s['buy_amount'])/intval($s['buy_quantity']));
        $ret[$i]['AccountSecurities'][$j]['avg_sell_price']=(!$s['sell_quantity'])?0:(floatval($s['sell_amount'])/intval($s['sell_quantity']));
        if($s['security_id'] == '1')$ret[$i]['deposit'] = $s['sell_amount'];
      }
    }
    return $ret;
  }
  public function getSecurities( $state='current')
  {
    
    $q = Doctrine_Query::create()
        ->select('s.symbol as symbol, as.security_id')
        ->addSelect('SUM(as.quantity) as quantity')
        ->addSelect('SUM(as.buy_quantity) as buy_quantity')        
        ->addSelect('SUM(as.sell_quantity)*(-1) as sell_quantity')
        ->addSelect('SUM(as.buy_amount)*(-1) as buy_amount')
        ->addSelect('SUM(as.sell_amount) as sell_amount')
        ->addSelect('SUM(as.amount) as amount')
        ->addSelect('SUM(as.dividend) as dividend')
        ->from('AccountSecurity as')
        ->leftJoin('as.Security s')
        ->leftJoin('as.Account a')
        ->where('a.user_id = ? AND s.id > ?', array($this->getId(),1))
        ->groupBy('s.id')
        ->orderBy('gain DESC') 
        ;
    switch($state)
    {
      case 'current':
        $mq = Doctrine_Query::create()
              ->select('MAX(date) as max')
              ->from('Price p')
              ->leftJoin('p.Security s')
              ->where('s.market = ? OR s.market = ?',array('NYSE','NASDAQ'))
              ->fetchArray();
        $q->leftJoin('s.Price p')
          ->addSelect('p.cprice as cprice')
          ->addSelect('p.cprice*SUM(as.quantity) as mkt_value')
          ->addSelect('p.cprice*SUM(as.quantity)+SUM(as.sell_amount + as.buy_amount) as gain')
          ->having('quantity > ?',0)
          ->andWhere('p.date = ?', $mq[0]["max"])
          ;
        break;
      case 'history':
        $q->having('quantity = ?', 0 )
          ->addSelect('SUM(as.sell_amount + as.buy_amount) as gain')
          ;
        break;
      default:
        break;
    }
    var_dump($q->getSqlQuery());
    $ret = $q->fetchArray();
    $cash = Doctrine_Query::create()
            ->addSelect('SUM(as.amount) as amount')
            ->addSelect('SUM(as.dividend) as dividend')
            ->addSelect('SUM(as.buy_quantity) as sell_quantity')
            ->addSelect('SUM(as.sell_quantity) as buy_quantity')
            ->addSelect('SUM(as.sell_amount) as sell_amount')
            ->addSelect('SUM(as.buy_amount) as buy_amount')
            ->from('Account a')
            ->leftJoin('a.AccountSecurities as')
            ->leftJoin('as.Security s')
            ->where('a.user_id = ?', array($this->getId()))
            ->andWhere('as.security_id = ?', '1')
            ->fetchArray();
    $cash=$cash[0];
    $cash['symbol'] = 'Cash';
    $cash['quantity']=$cash['amount'];
    $cash['mkt_value']=$cash['amount'];
    $cash['gain']=0;
    $cash['cprice'] = 1;
    $ret[]=$cash;
    
    $total = array();
    $total['symbol'] = 'Total';
    $total['quantity'] = 0;
    $total['mkt_value'] = 0;
    $total['gain'] = 0;
    $total['dividend'] = 0;
    $total['amount'] = 0;
    $total['buy_quantity'] = 0;
    $total['sell_quantity'] = 0;
    $total['buy_amount'] = 0;
    $total['sell_amount'] = 0;
    foreach($ret as $s)
    {
      $total['quantity']      += $s['quantity'];
      $total['gain']          += $s['gain'];
      $total['dividend']      += $s['dividend'];
      $total['amount']        += $s['amount'];
      $total['buy_quantity']  += $s['buy_quantity'];
      $total['buy_amount']    += $s['buy_amount'];
      $total['sell_quantity'] += $s['sell_quantity'];
      $total['sell_amount']   += $s['sell_amount'];
      switch($state)
      {
        case 'current':
          $total['mkt_value'] += $s['mkt_value'];
          $total['cprice'] = $total['mkt_value']/$total['quantity'];
          break;
        case 'history':break;
      }
    }
    
    $ret[]=$total;
    return $ret;
  }
}
